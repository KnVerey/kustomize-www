<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Certificate Chain</title>
	
	<meta name="author" content="Replicated">
	<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png" />
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png" />
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png" />
	<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png" />
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png" />
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png" />
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png" />
	<link rel="icon" type="image/png" href="/favicons/favicon-196x196.png" sizes="196x196" />
	<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96" />
	<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16" />
	<link rel="icon" type="image/png" href="/favicons/favicon-128.png" sizes="128x128" />
	<meta name="application-name" content="&nbsp;"/>
	<meta name="msapplication-TileColor" content="#FFFFFF" />
	<meta name="msapplication-TileImage" content="mstile-144x144.png" />
	<meta name="msapplication-square70x70logo" content="mstile-70x70.png" />
	<meta name="msapplication-square150x150logo" content="mstile-150x150.png" />
	<meta name="msapplication-wide310x150logo" content="mstile-310x150.png" />
	<meta name="msapplication-square310x310logo" content="mstile-310x310.png" />
	<link rel="stylesheet" href='/css/style-7a29e25363.css'>
	<link rel="stylesheet" href='/css/featherlight.min.css'>
	<link rel="stylesheet" href="/css/highlight/prism.css">
	
	<meta name="generator" content="Hugo 0.26" />
	
	<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
	<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
</head>
<body>
	<header>
		<nav>
			<div class="container u-position--relative">
				<a href="/search" id="mobile-search" class="searchIcon--white"></a>
				<span id="toggleNav" class="u-show--mobileTablet icon u-cursor--pointer"></span>
				<ul class="nav-list paddingContainer u-position--relative">
					<li>
						<a class="logo-link" href="/">
							<img width="109" src="/images/logo@2x.png"/>
						</a>
					</li>
					<li>
						<ul id="headerLinks" class="header-links">
							
								<li><a href="/guides/">Guides</a></li>
							
								<li><a href="/docs/native/getting-started/overview/">Documentation</a></li>
							
								<li><a href="/api/">API Reference</a></li>
							
								<li><a href="https://help.replicated.com/community/">Community</a></li>
							
							<li>
								<div class="search-form">
									<input type="text" placeholder="What are you looking for?" id="search-field" style="display: none;" />
									<span class="searchIcon--white" id="desktop-search"></span>
								</div>
							</li>
							<li class="log-in-link">
								<span><a href="https://vendor.replicated.com" target="_blank">Log in</a></span>
								
							</li>
						</ul>
					</li>
				</ul>
			</div>
		</nav>
	</header>

	<main>
		<article class="single">
				
					<div class="u-gradient--redToRed main-section header flex-column flex1 justifyContent--center">
				
				<div class="container">
					<div class="paddingContainer">
						<div class="flex flex-auto u-width--full justifyContent--spaceBetween alignItems--center u-marginTop--more">
							<div class="u-width--full u-marginRight--more">
								<h1 class="u-color--white u-fontWeight--bold u-fontSize--header u-textAlign--left">Certificate Chain</h1>
								<p class="u-fontSize--normal u-fontWeight--medium u-color--white u-marginTop--normal u-lineHeight--normal">An advanced walk through for using the Replicated cert command in an app&#39;s YAML definition to generate new TLS certificates for customer use in an application.</p>
							</div>
							<div class="flex-auto u-hidden--mobileTablet">
								<span class="icon u-replicatedCircle u-marginRight--normal"></span>
							</div>
						</div>
						
					</div>
				</div>
			</div>
			<div class="container">
				<div class="paddingContainer">
					<div class="u-flexTabletReflow flex1">
						<div class="flex-auto sidebar-wrapper">
							



<div class="sidebar">
        <div class="dropdown u-marginBottom--most">
            <p class="u-fontWeight--bold u-fontSize--largest u-color--tuna u-paddingBottom--normal">Documentation</p>
            <p class="u-fontSize--large u-fontWeight--medium u-cursor--pointer flex justifyContent--spaceBetween alignItems--center" id="dropdown-link">
                
                    <span>Native Scheduler</span>
                
                <span class="icon u-chevronIcon u-margingRight--small"></span>
            </p>
            <div class="menu" id="scheduler-dropdown-menu" style="display: none">
                <div class="u-paddingTop--small u-fontSize--normal u-fontWeight--bold u-color--curiousBlue u-paddingLeft--small">
                    <a href="/docs/native/getting-started/overview" class="u-color--curiousBlue">Replicated</a>
                    <div class="u-marginTop--small">
                        <a href="/docs/native/getting-started/overview" class="u-fontWeight--medium u-color--tuna u-fontSize--small">
                            <p class="scheduler-menu-item-sub" class="u-lineHeight--normal">Native Scheduler</p>
                        </a>
                        <a href="/docs/kubernetes/getting-started/overview" class="u-fontWeight--medium u-color--tuna u-fontSize--small">
                            <p class="scheduler-menu-item-sub" class="u-lineHeight--normal">Kubernetes</p>
                        </a>
                        <a href="/docs/swarm/getting-started/overview" class="u-fontWeight--medium u-color--tuna u-fontSize--small">
                            <p class="scheduler-menu-item-sub" class="u-lineHeight--normal">Docker Swarm</p>
                        </a>
                    </div>
                </div>
                <div class="u-borderTop--gray u-paddingTop--normal u-marginTop--small u-fontSize--normal u-fontWeight--bold u-color--curiousBlue u-paddingLeft--small">
                    <a href="/docs/config-screen/config-yaml/" class="u-color--curiousBlue">Features</a>
                    <div class="u-marginTop--small">
                        <a href="/docs/config-screen/config-yaml/" class="u-fontWeight--medium u-color--tuna u-fontSize--small">
                            <p class="scheduler-menu-item-sub" class="u-lineHeight--normal">Config Screen</p>
                        </a>
                        <a href="/docs/snapshots/overview/" class="u-fontWeight--medium u-color--tuna u-fontSize--small">
                            <p class="scheduler-menu-item-sub" class="u-lineHeight--normal">Snapshots</p>
                        </a>
                        <a href="/docs/ldap-and-identity/overview/" class="u-fontWeight--medium u-color--tuna u-fontSize--small">
                            <p class="scheduler-menu-item-sub" class="u-lineHeight--normal">LDAP & Identity Integration</p>
                        </a>
                        <a href="/docs/registry/security/" class="u-fontWeight--medium u-color--tuna u-fontSize--small">
                            <p class="scheduler-menu-item-sub" class="u-lineHeight--normal">Replicated Private Registry</p>
                        </a>
                    </div>
                </div>
                <div class="u-borderTop--gray u-paddingTop--normal u-marginTop--small u-fontSize--normal u-fontWeight--bold u-color--curiousBlue u-paddingLeft--small">
                    <a href="/docs/ship" class="u-fontWeight--medium u-color--tuna u-fontSize--normal">
                        <p class="scheduler-menu-item-sub" class="u-lineHeight--normal">Ship</p>
                    </a>
                </div>
            </div>
        </div>
        <div class="desktop-only">
            
            <div class="u-marginBottom--most">
                <h3 class="u-fontWeight--bold u-fontSize--large u-lineHeight--normal u-borderBottom--gray u-paddingBottom--normal u-marginBottom--normal">Replicated Native Scheduler</h3>
                
                    
                    
                        
                        <h3 class="u-fontWeight--medium u-fontSize--normal u-marginTop--normal u-lineHeight--normal">
                            <a href="/docs/native/getting-started/overview/" class=" u-color--tuna ">Replicated Native Scheduler</a>
                        </h3>
                        
                    
                        
                        <h3 class="u-fontWeight--medium u-fontSize--normal u-marginTop--normal u-lineHeight--normal">
                            <a href="/docs/native/packaging-an-application/overview/" class=" u-color--tuna ">Packaging An Application</a>
                        </h3>
                        
                    
                        
                        <h3 class="u-fontWeight--medium u-fontSize--normal u-marginTop--normal u-lineHeight--normal">
                            <a href="/docs/native/customer-installations/overview/" class=" u-color--tuna ">Managing Customer Installations</a>
                        </h3>
                        
                    
                        
                        <h3 class="u-fontWeight--medium u-fontSize--normal u-marginTop--normal u-lineHeight--normal">
                            <a href="/docs/native/examples/overview/" class=" u-color--tuna ">Native Scheduler Examples</a>
                        </h3>
                        
                            <div class="u-paddingLeft--normal u-marginTop--small u-marginBottom--small">
                                
                                    
                                
                                    
                                    <p class="u-paddingTop--small u-fontSize--normal u-lineHeight--normal">
                                        <a href="/docs/native/examples/load-balancer/" class=" u-color--curiousBlue ">
                                            Load Balancer
                                        </a>
                                    </p>
                                    
                                
                                    
                                    <p class="u-paddingTop--small u-fontSize--normal u-lineHeight--normal">
                                        <a href="/docs/native/examples/every-component-option/" class=" u-color--curiousBlue ">
                                            Every Component Option
                                        </a>
                                    </p>
                                    
                                
                                    
                                    <p class="u-paddingTop--small u-fontSize--normal u-lineHeight--normal">
                                        <a href="/docs/native/examples/counter-app/" class=" u-color--curiousBlue ">
                                            Counter App
                                        </a>
                                    </p>
                                    
                                
                                    
                                    <p class="u-paddingTop--small u-fontSize--normal u-lineHeight--normal">
                                        <a href="/docs/native/examples/certificate-chain/" class=" u-color--curiousBlueDark u-fontWeight--bold ">
                                            Certificate Chain
                                        </a>
                                    </p>
                                    
                                
                            </div>
                        
                    
                
            </div>
            
            
            
            
            
            
            
            
            
            
            
        </div>
    </div>

						</div>
						<div class="flex1 page-content-wrapper">
							<div class="page-content">
								

<h2 id="certificate-chain-app">Certificate Chain App</h2>

<p>This app is an example of some of the more advanced features of Replicated.</p>

<p>Using the cert command in your app&rsquo;s YAML definition, you can transparently and easily generate new TLS certificates for customer use in your app. For example, one of your containers may be serving an API via HTTPS for your other containers to consume. Ideally, the communication between the services running in your containers would be encrypted and authenticated. That&rsquo;s where the cert command becomes useful.</p>

<p>All certificates generated by the cert command are not self-signed; they are signed by a unique certificate authority (CA) created by the Replicated management container. Template functions are provided for accessing this CA so that your services can add it to their trust stores and perform proper validation of the chain.</p>

<p>This example app consists of two containers, one which runs a tiny HTTPS server program, and another which runs a similarly-tiny HTTPS client continuously issuing requests to the server. We want the communication between these two containerized services to be both encrypted and authenticated, so we make use of TLS and the Replicated cert command.</p>

<p>The Go source for these two small programs are provided here for your reference.</p>

<pre><code class="language-go">package main

import (
  &quot;log&quot;
  &quot;net/http&quot;
)

func handler(w http.ResponseWriter, req *http.Request) {
  w.Header().Set(&quot;Content-Type&quot;, &quot;text/plain&quot;)
  w.Write([]byte(&quot;This is an example server.\n&quot;))
}

func main() {
  http.HandleFunc(&quot;/&quot;, handler)
  err := http.ListenAndServeTLS(&quot;:10443&quot;, &quot;/opt/cert_chain.pem&quot;, &quot;/opt/private_key.pem&quot;, nil)
  if err != nil {
    log.Fatal(err)
  }
}
</code></pre>

<pre><code class="language-go">package main

import (
  &quot;crypto/tls&quot;
  &quot;crypto/x509&quot;
  &quot;io/ioutil&quot;
  &quot;log&quot;
  &quot;net/http&quot;
  &quot;time&quot;
)

func main() {
  pem, err := ioutil.ReadFile(&quot;/opt/ca.pem&quot;)
  if err != nil {
    log.Fatalln(err)
  }

  pool := x509.NewCertPool()
  if !pool.AppendCertsFromPEM(pem) {
    log.Fatalln(&quot;Couldn't import CA&quot;)
  }

  tr := &amp;http.Transport{
    TLSClientConfig: &amp;tls.Config{RootCAs: pool},
  }

  client := &amp;http.Client{Transport: tr}

  for {
    time.Sleep(time.Second * 5)
    resp, err := client.Get(&quot;https://server.replexample.int:10443/&quot;)
    if err != nil {
      log.Println(err)
      continue
    }

    if resp.StatusCode != 200 {
      body, _ := ioutil.ReadAll(resp.Body)
      log.Printf(&quot;HTTPS request failed. Response follows:\n  Header: %+v\n  Body: %s\n&quot;, resp.Header, string(body))
    }

    resp.Body.Close()
  }
}
</code></pre>

<p>As you can see, the client service accesses the server via a FQDN (server.replexample.int) instead of an IP address. This hostname matches the Common Name field of the certificate generated using the cert command, so validation will succeed.</p>

<p>This particular hostname exists only inside the client&rsquo;s container. This is enabled by a field in the app&rsquo;s YAML definition called extra_hosts. Any number of hostname &amp; IP address pairings can be defined this way.</p>

<p>Additionally, both services require access to parts of the certificate chain that has been generated by Replicated: the client needs access to the CA at /opt/ca.pem, and the server needs access to a concatenation of the certificate &amp; the CA at /opt/cert_chain.pem as well as the certificate&rsquo;s corresponding private key at /opt/private_key.pem. These files are made available to the services via template functions in the app&rsquo;s YAML definition.</p>

<p>The app YAML is presented below with comments describing the function of each section.</p>

<pre><code class="language-yaml">---
replicated_api_version: &quot;1.0.0&quot;
name: &quot;CACertExample&quot;

# This is what kicks off the generation of the certificate.
# Notice the arguments: we want a 2048-bit key, and CN *.replexample.int
# The output is stored in the &quot;cert_out&quot; identifier. There are 3 values
# returned by this command. By index, these are:
# 0: the generated private key
# 1: the generated certificate
# 2: the certificate authority used to sign the generated certificate
cmds:
- name: cert_out
  cmd: cert
  args:
  - 2048
  - &quot;*.replexample.int&quot;

# Here, in the config section, we write the return values of 'cert_out'
# to a series of separate config options. These are marked 'hidden'
# so that they won't be shown on the settings screen.
# Writing these values into config options allows them to be used in
# template functions (see the &quot;components&quot; section below).
config:
- name: HiddenCertValues
  hidden: true
  items:
  - type: file
    name: newcert_privatekey
    hidden: true
    data_cmd:
      name: cert_out
      value_at: 0
  - type: file
    name: newcert_cert
    hidden: true
    data_cmd:
      name: cert_out
      value_at: 1
  - type: file
    name: newcert_ca
    hidden: true
    data_cmd:
      name: cert_out
      value_at: 2

components:
- name: ComponentOne
  containers:
  - source: public
    image_name: repljoe/ca_cert_example_server
    version: &quot;1&quot;
    ports:
    - port_type: tcp
      public_port: &quot;10443&quot;
      private_port: &quot;10443&quot;
    config_files:

    # Here we write the concatenated certificate &amp; CA together to
    # a file that will be read by the server program. The template
    # function 'ConfigOptionData' returns the raw data stored in a
    # config option.
    - filename: /opt/cert_chain.pem
      contents: |
        {{repl ConfigOptionData &quot;newcert_cert&quot; }}
        {{repl ConfigOptionData &quot;newcert_ca&quot; }}
      file_mode: &quot;0600&quot;
    customer_files:

    # The private key is a simpler case: we can write the contents
    # of the config option directly to a file using an entry here in
    # the 'config_files' section.
    - name: newcert_privatekey
      filename: /opt/private_key.pem
      file_mode: &quot;0600&quot;
- name: ComponentTwo
  cluster: true
  tags:
  - client
  containers:
  - source: public
    image_name: repljoe/ca_cert_example_client
    version: &quot;3&quot;

    # In order for the certificate chain to be properly validated,
    # the client needs to connect to the server using a hostname which
    # matches the Common Name field in the certificate it (the server)
    # is using.
    # In our 'cert' command at the top of this file, we explicitly
    # requested that the CN be a wildcard: *.replexample.int
    # We use the 'extra_hosts' directive here to define a hostname which
    # will satisfy the certificate validation process.
    # The IP address of the host with the server container is returned
    # dynamically by the 'NodePrivateIPAddress' template function.
    extra_hosts:
    - hostname: server.replexample.int
      address: '{{repl NodePrivateIPAddress &quot;ComponentOne&quot; &quot;repljoe/ca_cert_example_server&quot; }}'
    customer_files:
    - name: newcert_ca
      filename: /opt/ca.pem
      file_mode: &quot;0600&quot;
</code></pre>

								<div class="prev-next-arrows justifyContent--spaceBetween flex u-marginTop--most">
									<div class="next flex u-textAlign--left">
										
											
												<a href="/docs/native/examples/counter-app/">
													<span class="icon u-chevronIcon"></span>
													Counter App
												</a>
											
										
										</div>
										<div class="previous flex u-textAlign--right">
										
											
										
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div>
				
			</div>
		</article>
	</main>
	<footer>
		<div class="container">
			<div class="footer-items-wrapper">
        <div class="footer-list flex1 paddingContainer">
					<div class="footer-list-item">
  <div class="footer-item">
    <div class="u-paddingBottom--normal">
      <a target="_blank" class="u-cursor--pointer" href="https://www.replicated.com">
        <img width="130" src="/images/footer_logo@2x.png"/>
      </a>
    </div>
    <div class="u-fontSize--small u-color--dustyGray u-marginBottom--small u-hidden--mobileTablet">&copy; 2018 <a> &nbsp;Replicated Inc.</a></div>
    <div class="u-fontSize--small u-color--dustyGray u-hidden--mobileTablet">All Rights Reserved</div>
  </div>
</div><div class="footer-list-item">
  <div class="footer-item">
    <p class="u-fontWeight--medium u-color--tuna">Help Center</p>
    <ul>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="/guides">Guides</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="/docs">Documentation</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="/api">API Reference</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://vendor.replicated.com/support">Contact Support</a></li>
    </ul>
  </div>
</div><div class="footer-list-item">
  <div class="footer-item">
    <p class="u-fontWeight--medium u-color--tuna">Company</p>
    <ul>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://www.replicated.com">About Replicated</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://blog.replicated.com">Replicated Blog</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://www.replicated.com/careers">Careers</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover">RSS Feed</a></li>
    </ul>
  </div>
</div><div class="footer-list-item">
  <div class="footer-item">
    <p class="u-fontWeight--medium u-color--tuna">Contact</p>
    <ul>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://twitter.com/replicatedhq">Twitter</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="mailto:contact@replicated.com">Email</a></li>
    </ul>
  </div>
</div><div class="footer-list-item">
  <div class="footer-item">
    <p class="u-fontWeight--medium u-color--tuna">More</p>
    <ul>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://github.com/replicatedhq">GitHub</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://www.enterpriseready.io">EnterpriseReady.io</a></li>
    </ul>
  </div>
</div>

        </div>
			</div>
		</div>
	</footer>

	
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-61084834-1', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
      </script>
    
 
	<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
	<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>

  
  

    
    
      
        <script src="/js/staging/autocomplete-search-native.js"></script>
      
      
    

  

	<script src="/js/prism.js"></script>
	<script>
		function toggleMenuClass() {
			this.classList.toggle("open");
			document.getElementById("headerLinks").classList.toggle("show");
		}
		const toggleMenu = document.getElementById("toggleNav");
		if (toggleMenu) {
			toggleMenu.addEventListener("click", toggleMenuClass);
		};
	</script>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="/js/featherlight.min.js"></script>
	<script>
		$('#desktop-search').on("click", function () {
      if(!$('#search-field').is(":visible")) {
        $('#search-field').show("slide", { direction: "right" }, 300);
        $('#search-field').focus();
      }
		});

    $('#search-field').on("blur", function () {
      $(this).hide("slide", { direction: "right" }, 300);
    });

    $('#dropdown-link').on('click', function() {
      $('#scheduler-dropdown-menu').toggle();
    });

    $(document).on('click', function(e) {
      var target = e.target;
      if(target.id !== "dropdown-link") {
        $('#scheduler-dropdown-menu').hide();
      }
    });

    $('.tooltip').tooltip({
      position: {  my: "center bottom-10", at: "center top"  },
      show: { effect: "fade", duration: 200 },
      hide: { effect: "fade", duration: 200 }
    });
	</script>
</body>
</html>
