<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Automated Deployment with a Kubernetes App</title>
	
	<meta name="author" content="Replicated">
	<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png" />
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png" />
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png" />
	<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png" />
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png" />
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png" />
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png" />
	<link rel="icon" type="image/png" href="/favicons/favicon-196x196.png" sizes="196x196" />
	<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96" />
	<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16" />
	<link rel="icon" type="image/png" href="/favicons/favicon-128.png" sizes="128x128" />
	<meta name="application-name" content="&nbsp;"/>
	<meta name="msapplication-TileColor" content="#FFFFFF" />
	<meta name="msapplication-TileImage" content="mstile-144x144.png" />
	<meta name="msapplication-square70x70logo" content="mstile-70x70.png" />
	<meta name="msapplication-square150x150logo" content="mstile-150x150.png" />
	<meta name="msapplication-wide310x150logo" content="mstile-310x150.png" />
	<meta name="msapplication-square310x310logo" content="mstile-310x310.png" />	
	<link rel="stylesheet" href='/css/style-0bcbae9332.css'>
	<link rel="stylesheet" href='/css/featherlight.min.css'>
	<link rel="stylesheet" href="/css/highlight/prism.css">
	
	<meta name="generator" content="Hugo 0.26" />
	
	<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
	<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
</head>
<body>
	<header>
		
			<nav class="other-nav">
		
			<div class="container u-position--relative">
				<ul class="flex justifyContent--spaceBetween alignItems--center nav-list paddingContainer u-position--relative">
					<li>
						<a class="logo-link" href="/">
							<img width="109" src="/images/ship-logo@2x.png"/>
						</a>
					</li>
					<li>
						<ul id="headerLinks" class="header-links">
							
								<li><a href="/docs" id="navItem--docs">Docs</a></li>
							
						</ul>
					</li>
				</ul>
			</div>
			<div class="container u-position--relative">
				<div class="guides-sub-nav">
    <div class="flex u-position--relative">
        <div class="arrow"></div>
        <div class="guide-wrapper flex flex-column">
            <h3 class="u-fontWeight--bold u-fontSize--normal u-color--shipGreen u-marginBottom--more">Configuring</h3>
            <div class="guide">
                <a href="/docs/initial-configuration">
                    <p class="u-fontSize--small u-fontWeight--medium u-marginBottom--small u-color--darkBlue u-lineHeight--normal">Initial Configuration</p>
                    <p class="u-fontSize--small u-color--dustyGray u-lineHeight--normal">Configuring an application for the first deployment</p>
                </a>
            </div>
        </div>
        <div class="guide-wrapper flex flex-column">
            <h3 class="u-fontWeight--bold u-fontSize--normal u-color--shipGreen u-marginBottom--more">Testing</h3>
            <div class="guide">
                <a href="/docs/automated-testing">
                    <p class="u-fontSize--small u-fontWeight--medium u-marginBottom--small u-color--darkBlue u-lineHeight--normal">Automated Testing</p>
                    <p class="u-fontSize--small u-color--dustyGray u-lineHeight--normal">How to test a Ship application</p>
                </a>
            </div>
        </div>
        <div class="guide-wrapper flex flex-column">
            <h3 class="u-fontWeight--bold u-fontSize--normal u-color--shipGreen u-marginBottom--more">Deploying</h3>
            <div class="guide">
                <a href="/docs/automated-deployment">
                    <p class="u-fontSize--small u-fontWeight--medium u-marginBottom--small u-color--darkBlue u-lineHeight--normal">Automated Deployment</p>
                    <p class="u-fontSize--small u-color--dustyGray u-lineHeight--normal">How to automate the deployment of a Ship application.</p>
                </a>
            </div>
            <div class="guide u-marginTop--more">
                <a href="/docs/automated-deployment-kubernetes-app">
                    <p class="u-fontSize--small u-fontWeight--medium u-marginBottom--small u-color--darkBlue u-lineHeight--normal">Automatically Deploying to Kubernetes</p>
                    <p class="u-fontSize--small u-color--dustyGray u-lineHeight--normal">Set up a continuous delivery process to automate updates of a Kubernetes application.</p>
                </a>
            </div>
        </div>
        <div class="guide-wrapper flex flex-column u-position--relative">
            <h3 class="u-fontWeight--bold u-fontSize--normal u-color--shipGreen u-marginBottom--more">Best Practices</h3>
            <div class="guide">
                <a href="/docs/manage-state">
                    <p class="u-fontSize--small u-fontWeight--medium u-marginBottom--small u-color--darkBlue u-lineHeight--normal">Managing State</p>
                    <p class="u-fontSize--small u-color--dustyGray u-lineHeight--normal">Securely store and manage the Ship state file.</p>
                </a>
            </div>
            <div class="see-more flex alignItems--center u-position--absolute">
                <a href="/docs" class="u-fontWeight--medium u-fontSize--normal u-color--curiousBlue u-paddingRight--normal">See all docs</a>
                <span class="icon u-chevronIcon"></span>
            </div>
        </div>
    </div>
</div>

			</div>
		</nav>
	</header>
<main>
    <article class="single">
        <div class="u-gradient--greenToGreen main-section header flex-column flex1 justifyContent--center">
            <div class="container">
                <div class="paddingContainer">
                    <div class="flex flex-auto u-width--full justifyContent--spaceBetween alignItems--center u-marginTop--more">
                        <div class="u-width--full u-marginRight--more">
                            <h1 class="u-color--white u-fontWeight--bold u-fontSize--header u-textAlign--left">Automated Deployment with a Kubernetes App</h1>
                            <p class="u-fontSize--normal u-fontWeight--medium u-color--white u-marginTop--normal u-lineHeight--normal">Automated Deployment with a Kubernetes App</p>
                        </div>
                        <div class="flex-auto u-hidden--mobileTablet">
                            <span class="icon u-replicatedKubernetes u-marginRight--normal"></span>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        <div class="container">
            <div class="paddingContainer">
                <div class="u-flexTabletReflow flex1">
                    <div class="flex-auto sidebar-wrapper">
                        <div class="sidebar">
                            <div class="toc u-marginBottom--most">
                                <h3 class="u-fontWeight--medium u-lineHeight--normal u-borderBottom--gray u-paddingBottom--normal u-marginBottom--normal">Automated Deployment with a Kubernetes App</h3>
								<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#initial-configuration">Initial Configuration</a></li>
<li><a href="#extract-the-state-json-and-ship-yml">Extract the state.json and ship.yml</a>
<ul>
<li><a href="#state-json">state.json</a></li>
<li><a href="#ship-yaml">ship.yaml</a></li>
</ul></li>
<li><a href="#configure-a-ci-cd-workflow">Configure a CI/CD workflow</a></li>
</ul></li>
</ul>
</nav>
                            </div>

                            
                                <div class="resources">
                                    <h3 class="u-fontWeight--medium u-borderBottom--gray u-paddingBottom--normal u-marginBottom--normal">Resources</h3>
                                    <p class="u-fontSize--small u-fontWeight--normal u-color--dustyGray u-marginTop--normal u-lineHeight--normal u-marginBottom--normal"> Here are some resources we've prepared for this guide.</p>
                                    <ul>
                                        
                                            <li> <a href="resources/ship_spec.yaml" class="u-fontSize--small" download>ship_spec.yaml</a> </li>
                                        
                                            <li> <a href="resources/circle.config" class="u-fontSize--small" download>circle.config</a> </li>
                                        
                                    </ul>
                                </div>
                            
                        </div>
                    </div>
                    <div class="flex1 page-content-wrapper">
                        
                            <div class="page-content">
                                

<p>Kubernetes applications delivered in Replicated Ship can be deployed using automation instead of manually running <code>kubectl</code> to deploy from a laptop. It&rsquo;s possible to deploy the first release of an application completely automated, even to airgapped environmnets. This document walks through an example application and how it will be configured and initially deployed.</p>

<h2 id="prerequisites">Prerequisites&nbsp;<a class="headline-hash" href="#prerequisites">#</a> </h2>

<p>In addition to any external resources the software vendor requries (databases, etc), you&rsquo;ll need to have:</p>

<ul>
<li>a version control system (VCS), such as GitHub Enterprise</li>
<li>a secure storage location, that can store a single, small, encrypted file</li>
<li>a continuous intergration / continuous delivery platform, such as CircleCI Enterprise or TravisCI Enterprise</li>
<li>a local Docker Registry, that is accessible to the target Kubernetes cluster, such as Artifactory</li>
<li>a working Kubernetes cluster that meets the minimum requirements provided by the software vendor</li>
</ul>

<h2 id="overview">Overview&nbsp;<a class="headline-hash" href="#overview">#</a> </h2>

<p>The process to deploy the first release, complete automated is to configure the release from a laptop running MacOS, Windows or Linux, and then store the release source file (<code>ship.yaml</code>) in a local VCS, and the configured Ship state (<code>state.json</code>) in a secure storage location. Then, a workflow can be built to take these two inputs and automate a build and deployment to the target Kubernetes cluster.</p>

<h2 id="initial-configuration">Initial Configuration&nbsp;<a class="headline-hash" href="#initial-configuration">#</a> </h2>

<p>From a laptop running Docker, run the setup command provided by the software vendor:</p>

<pre><code class="language-shell">curl -sSL https://get.replicated.com/ship?customer_id=&lt;your_license_key&gt; | docker-compose -f - up
</code></pre>

<p>This will download a couple of Docker containers and then show a message similar to this:</p>

<pre><code class="language-shell">Please visit the following URL in your browser to continue the installation

        http://localhost:8800

</code></pre>

<p>Next, open the URL provided (<a href="http://localhost:8800">http://localhost:8800</a>), and supply all of the intial configuration values and click Save.</p>

<h2 id="extract-the-state-json-and-ship-yml">Extract the state.json and ship.yml&nbsp;<a class="headline-hash" href="#extract-the-state-json-and-ship-yml">#</a> </h2>

<p>At this point, the laptop has all of the required Docker images, configured Kubernetes manifests, and scripts needed to deploy this application using <code>kubectl</code>. That&rsquo;s not the goal here, so don&rsquo;t run the provided scripts or commands.</p>

<h3 id="state-json">state.json&nbsp;<a class="headline-hash" href="#state-json">#</a> </h3>

<p>The configured state should be in a single file, stored in <code>.ship/state.json</code>. This file may contain secrets and confidental information such as database passwords and more. Encrypt this file from the command line (// TODO provide an example here) and manually upload it to your secure storage location. For example:</p>

<pre><code class="language-shell">$ aws s3 upload my-app-config | encrypt ./ship/state.json
</code></pre>

<h3 id="ship-yaml">ship.yaml&nbsp;<a class="headline-hash" href="#ship-yaml">#</a> </h3>

<p>The original YAML file that the software vendor created and was used as an input to create the local assets is stored in <code>./installer/ship/ship.yaml</code>. This file doesn&rsquo;t contain any secrets, it&rsquo;s a generic release manifest. Commit this file to a new repo in source control. For example:</p>

<pre><code class="language-shell">cd installer/ship
git init
git add ship.yml
git remote add ...
git push origin master
</code></pre>

<h2 id="configure-a-ci-cd-workflow">Configure a CI/CD workflow&nbsp;<a class="headline-hash" href="#configure-a-ci-cd-workflow">#</a> </h2>

<p>Next, configure a CI/CD workflow to take the state.json and ship.yml as inputs, and run the ship container in a headless (automated) mode, which will produce the same assets that were created when running the Admin Console locally. The following commands should be added to the CI/CD process:</p>

<pre><code class="language-shell">$ docker pull repliated/ship:1
$ aws s3 get my-app-config/state.json
$ decrypt state.json
$ docker run -v `PWD`:/in  -v`PWD`/installer:/out -e CUSTOMER_ID=&lt;customer_id&gt; replicated/ship:1 --headless
$ ./installer/scripts/install.sh
$ ./installer/scripts/test.sh
$ aws s3 upload my-app-config | encrypt ./ship/state.json
</code></pre>

<p>This will pull the Replicated Ship container, download the encrypted state, decrypt the state. Then it will use the Ship container to build and fetch all required assets. Then, the CI/CD server will run the installation script and then test the created installation. Finally, the above script will encrypt the latest state values, and store them securely for the next release.</p>

                            </div>
                        
                    </div>
                </div>
            </div>
        </div>
        <div>
            
        </div>
    </article>
</main>
	<footer>
		<div class="container">
			<div class="footer-items-wrapper">
        <div class="footer-list flex1 paddingContainer">
					<div class="footer-list-item">
  <div class="footer-item">
    <div class="u-paddingBottom--normal">
      <a target="_blank" class="u-cursor--pointer" href="https://www.replicated.com">
        <img width="130" src="/images/footer_logo@2x.png"/>
      </a>
    </div>
    <div class="u-fontSize--small u-color--dustyGray u-marginBottom--small u-hidden--mobileTablet">&copy; 2018 <a> &nbsp;Replicated Inc.</a></div>
    <div class="u-fontSize--small u-color--dustyGray u-hidden--mobileTablet">All Rights Reserved</div>
  </div>
</div><div class="footer-list-item">
  <div class="footer-item">
    <p class="u-fontWeight--medium u-color--tuna">Company</p>
    <ul>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://www.replicated.com">About Replicated</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://blog.replicated.com">Replicated Blog</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover">RSS Feed</a></li>
    </ul>
  </div>
</div><div class="footer-list-item">
  <div class="footer-item">
    <p class="u-fontWeight--medium u-color--tuna">Contact</p>
    <ul>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://twitter.com/replicatedhq">Twitter</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="mailto:contact@replicated.com">Email</a></li>
    </ul>
  </div>
</div><div class="footer-list-item">
  <div class="footer-item">
    <p class="u-fontWeight--medium u-color--tuna">More</p>
    <ul>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://github.com/replicatedhq">GitHub</a></li>
      <li><a class="u-color--dustyGray u-textDecoration--underlineOnHover" href="https://www.enterpriseready.io">EnterpriseReady.io</a></li>
    </ul>
  </div>
</div>

        </div>
			</div>
		</div>
	</footer>

	
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-61084834-1', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
      </script>
    
 
	<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
	<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>

  
  

    
    
      
        <script src="/js/staging/autocomplete-search.js"></script>
      
      
    

  

	<script src="/js/prism.js"></script>
	<script>
		function toggleMenuClass() {
			this.classList.toggle("open");
			document.getElementById("headerLinks").classList.toggle("show");
		}
		const toggleMenu = document.getElementById("toggleNav");
		if (toggleMenu) {
			toggleMenu.addEventListener("click", toggleMenuClass);
		};
	</script>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="/js/featherlight.min.js"></script>
	<script>
		$('#desktop-search').on("click", function () {
      if(!$('#search-field').is(":visible")) {
        $('#search-field').show("slide", { direction: "right" }, 300);
        $('#search-field').focus();
      }
		});

    $('#search-field').on("blur", function () {
      $(this).hide("slide", { direction: "right" }, 300);
    });

    $('#dropdown-link').on('click', function() {
      $('#scheduler-dropdown-menu').toggle();
    });

    $(document).on('click', function(e) {
      var target = e.target;
      if(target.id !== "dropdown-link") {
        $('#scheduler-dropdown-menu').hide();
      }
    });

    $('.tooltip').tooltip({
      position: {  my: "center bottom-10", at: "center top"  },
      show: { effect: "fade", duration: 200 },
      hide: { effect: "fade", duration: 200 }
    });

    $('#navItem--docs').on("mouseenter", function () {
      $('.guides-sub-nav').show();
    });
    $('#navItem--modern-on-prem').on("mouseenter", function () {
      $('.guides-sub-nav').hide();
    });
    
    $('.home-nav').on("mouseleave", function () {
      $('.guides-sub-nav').hide();
    });
    $('.other-nav').on("mouseleave", function (e) {
      $('.guides-sub-nav').hide();
    });
  </script>
  <script>
    $('a[href*="#"]')
      
      .not('[href="#"]')
      .not('[href="#0"]')
      .click(function(event) {
        
        if (
          location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') 
          && 
          location.hostname == this.hostname
        ) {
          
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
          
          if (target.length) {
            
            event.preventDefault();
            $('html, body').animate({
              scrollTop: target.offset().top
            }, 400);
          }
        }
      });
  </script>
</body>
</html>
